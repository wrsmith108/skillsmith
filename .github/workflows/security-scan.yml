# SMI-1456: Weekly Automated Security Scan Workflow
# Scans all registered skills for security vulnerabilities
# Results are uploaded to GitHub Code Scanning and posted as summary

name: Security Scan

on:
  schedule:
    # Run every Sunday at 2:00 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      scan_scope:
        description: 'Scope of scan'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - verified
          - community
          - experimental
      risk_threshold:
        description: 'Risk score threshold (0-100)'
        required: false
        default: '40'
        type: string

env:
  NODE_VERSION: '22'

jobs:
  security-scan:
    name: Skill Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      total_skills: ${{ steps.scan.outputs.total_skills }}
      total_findings: ${{ steps.scan.outputs.total_findings }}
      failed_scans: ${{ steps.scan.outputs.failed_scans }}
      avg_risk_score: ${{ steps.scan.outputs.avg_risk_score }}
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Run security scan
        id: scan
        run: |
          # Create output directory
          mkdir -p security-reports

          # Run the security scanner on all skills
          node -e "
            const { SecurityScanner } = require('./packages/core/dist/security/index.js');
            const { SkillRepository } = require('./packages/core/dist/repositories/SkillRepository.js');
            const { openDatabase } = require('./packages/core/dist/db/schema.js');
            const fs = require('fs');
            const path = require('path');

            async function runScan() {
              const scanner = new SecurityScanner({
                riskThreshold: parseInt('${{ inputs.risk_threshold || '40' }}', 10)
              });

              const reports = [];
              const summaries = [];
              const annotations = [];
              const sarifs = [];

              // For CI, we scan fixture skills
              const fixturesPath = './packages/core/tests/fixtures/skills/seed-skills.json';
              if (fs.existsSync(fixturesPath)) {
                const fixtures = JSON.parse(fs.readFileSync(fixturesPath, 'utf8'));
                const skills = [...(fixtures.realSkills || []), ...(fixtures.testFixtures || [])];

                // Filter by scope if specified
                const scope = '${{ inputs.scan_scope || 'all' }}';
                const filteredSkills = scope === 'all'
                  ? skills
                  : skills.filter(s => s.trustTier === scope);

                console.log(\`Scanning \${filteredSkills.length} skills (scope: \${scope})\`);

                for (const skill of filteredSkills) {
                  // For real scanning, we'd fetch the skill content
                  // Here we use description as sample content
                  const content = skill.description || '';
                  const report = scanner.scan(skill.id, content);

                  reports.push(report);
                  summaries.push(SecurityScanner.toSummary(report));
                  annotations.push(...SecurityScanner.toGitHubAnnotations(report));
                  sarifs.push(SecurityScanner.toSARIF(report));
                }
              }

              // Write reports
              fs.writeFileSync(
                'security-reports/summaries.json',
                JSON.stringify(summaries, null, 2)
              );

              fs.writeFileSync(
                'security-reports/annotations.txt',
                annotations.join('\\n')
              );

              // Combine SARIF results
              const combinedSarif = {
                '\$schema': 'https://json.schemastore.org/sarif-2.1.0.json',
                version: '2.1.0',
                runs: sarifs.flatMap(s => s.runs || [])
              };
              fs.writeFileSync(
                'security-reports/results.sarif',
                JSON.stringify(combinedSarif, null, 2)
              );

              // Generate summary
              const totalFindings = summaries.reduce((sum, s) => sum + s.totalFindings, 0);
              const failedScans = summaries.filter(s => !s.passed).length;
              const avgRiskScore = summaries.length > 0
                ? Math.round(summaries.reduce((sum, s) => sum + s.riskScore, 0) / summaries.length)
                : 0;

              const summary = {
                scannedAt: new Date().toISOString(),
                totalSkills: summaries.length,
                totalFindings,
                failedScans,
                avgRiskScore,
                bySeverity: {
                  critical: summaries.reduce((sum, s) => sum + (s.bySeverity.critical || 0), 0),
                  high: summaries.reduce((sum, s) => sum + (s.bySeverity.high || 0), 0),
                  medium: summaries.reduce((sum, s) => sum + (s.bySeverity.medium || 0), 0),
                  low: summaries.reduce((sum, s) => sum + (s.bySeverity.low || 0), 0),
                }
              };

              fs.writeFileSync(
                'security-reports/summary.json',
                JSON.stringify(summary, null, 2)
              );

              console.log('\\nScan Summary:');
              console.log(\`  Skills scanned: \${summary.totalSkills}\`);
              console.log(\`  Total findings: \${summary.totalFindings}\`);
              console.log(\`  Failed scans: \${summary.failedScans}\`);
              console.log(\`  Average risk score: \${summary.avgRiskScore}\`);
              console.log(\`  Critical: \${summary.bySeverity.critical}\`);
              console.log(\`  High: \${summary.bySeverity.high}\`);
              console.log(\`  Medium: \${summary.bySeverity.medium}\`);
              console.log(\`  Low: \${summary.bySeverity.low}\`);

              // Set outputs using GITHUB_OUTPUT file (new syntax since 2022)
              const outputFile = process.env.GITHUB_OUTPUT;
              if (outputFile) {
                fs.appendFileSync(outputFile, \`total_skills=\${summary.totalSkills}\\n\`);
                fs.appendFileSync(outputFile, \`total_findings=\${summary.totalFindings}\\n\`);
                fs.appendFileSync(outputFile, \`failed_scans=\${summary.failedScans}\\n\`);
                fs.appendFileSync(outputFile, \`avg_risk_score=\${summary.avgRiskScore}\\n\`);
              }

              // Exit with error if critical findings
              if (summary.bySeverity.critical > 0) {
                console.log('\\n::error::Critical security findings detected!');
                process.exit(1);
              }
            }

            runScan().catch(err => {
              console.error('Scan failed:', err);
              process.exit(1);
            });
          "

      - name: Upload SARIF results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: security-reports/results.sarif
          category: skillsmith-security-scan

      - name: Generate step summary
        if: always()
        run: |
          echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f security-reports/summary.json ]; then
            TOTAL_SKILLS=$(jq '.totalSkills' security-reports/summary.json)
            TOTAL_FINDINGS=$(jq '.totalFindings' security-reports/summary.json)
            FAILED_SCANS=$(jq '.failedScans' security-reports/summary.json)
            AVG_RISK=$(jq '.avgRiskScore' security-reports/summary.json)
            CRITICAL=$(jq '.bySeverity.critical' security-reports/summary.json)
            HIGH=$(jq '.bySeverity.high' security-reports/summary.json)
            MEDIUM=$(jq '.bySeverity.medium' security-reports/summary.json)
            LOW=$(jq '.bySeverity.low' security-reports/summary.json)

            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Skills Scanned | $TOTAL_SKILLS |" >> $GITHUB_STEP_SUMMARY
            echo "| Total Findings | $TOTAL_FINDINGS |" >> $GITHUB_STEP_SUMMARY
            echo "| Failed Scans | $FAILED_SCANS |" >> $GITHUB_STEP_SUMMARY
            echo "| Avg Risk Score | $AVG_RISK |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Findings by Severity" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ”´ Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ  High | $HIGH |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ¡ Medium | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ¢ Low | $LOW |" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No scan results available" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload scan artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: security-reports/
          retention-days: 30

      - name: Output annotations
        if: always()
        run: |
          if [ -f security-reports/annotations.txt ]; then
            cat security-reports/annotations.txt
          fi

  # SMI-1457: Create or update Security project tracking
  update-quarantine-tracking:
    name: Update Quarantine Tracking
    runs-on: ubuntu-latest
    needs: security-scan
    if: ${{ needs.security-scan.outputs.failed_scans > 0 }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download scan results
        uses: actions/download-artifact@v4
        with:
          name: security-scan-results
          path: security-reports/

      - name: Create quarantine issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "## Quarantine Tracking" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Skills with security findings should be reviewed and potentially quarantined." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See the Security project in Linear for tracking: SMI-1457" >> $GITHUB_STEP_SUMMARY
