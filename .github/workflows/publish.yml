# SMI-1251: Aligned with Docker-first CI strategy
name: Publish Packages

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no actual publish)'
        required: false
        default: 'true'
        type: boolean

# Required for GitHub Packages publishing
permissions:
  contents: read
  packages: write

concurrency:
  group: publish-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: '22'
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # SMI-1301: Pre-publish validation before expensive Docker build
  # Catches version conflicts and configuration issues early
  pre-publish-check:
    name: Pre-Publish Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    outputs:
      core-exists: ${{ steps.version-check.outputs.core_exists }}
      mcp-exists: ${{ steps.version-check.outputs.mcp_exists }}
      cli-exists: ${{ steps.version-check.outputs.cli_exists }}
      enterprise-exists: ${{ steps.version-check.outputs.enterprise_exists }}
      any-to-publish: ${{ steps.version-check.outputs.any_to_publish }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # SMI-1317: Verify required dependencies are available
      - name: Verify dependencies
        run: |
          if ! command -v jq &> /dev/null; then
            echo "::error::jq is required but not installed"
            exit 1
          fi
          echo "âœ“ jq is available"

      # SMI-1321: Validate packages directory exists
      - name: Validate packages directory
        run: |
          if [ ! -d packages ] || [ -z "$(ls -A packages 2>/dev/null)" ]; then
            echo "::error::No packages found in packages/ directory"
            exit 1
          fi
          PKG_COUNT=$(ls -d packages/*/package.json 2>/dev/null | wc -l)
          echo "âœ“ Found $PKG_COUNT packages"

      - name: Check version availability
        id: version-check
        run: |
          echo "## Version Availability Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Local Version | Published | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------------|-----------|--------|" >> $GITHUB_STEP_SUMMARY

          ANY_TO_PUBLISH=false

          # Check @skillsmith/core
          VERSION=$(jq -r .version packages/core/package.json)
          PUBLISHED=$(npm view @skillsmith/core@$VERSION version 2>/dev/null || echo '')
          if [ -n "$PUBLISHED" ]; then
            echo "core_exists=true" >> $GITHUB_OUTPUT
            echo "| @skillsmith/core | $VERSION | $PUBLISHED | â­ï¸ Skip |" >> $GITHUB_STEP_SUMMARY
          else
            echo "core_exists=false" >> $GITHUB_OUTPUT
            echo "| @skillsmith/core | $VERSION | - | ðŸ“¦ Publish |" >> $GITHUB_STEP_SUMMARY
            ANY_TO_PUBLISH=true
          fi

          # Check @skillsmith/mcp-server
          VERSION=$(jq -r .version packages/mcp-server/package.json)
          PUBLISHED=$(npm view @skillsmith/mcp-server@$VERSION version 2>/dev/null || echo '')
          if [ -n "$PUBLISHED" ]; then
            echo "mcp_exists=true" >> $GITHUB_OUTPUT
            echo "| @skillsmith/mcp-server | $VERSION | $PUBLISHED | â­ï¸ Skip |" >> $GITHUB_STEP_SUMMARY
          else
            echo "mcp_exists=false" >> $GITHUB_OUTPUT
            echo "| @skillsmith/mcp-server | $VERSION | - | ðŸ“¦ Publish |" >> $GITHUB_STEP_SUMMARY
            ANY_TO_PUBLISH=true
          fi

          # Check @skillsmith/cli
          VERSION=$(jq -r .version packages/cli/package.json)
          PUBLISHED=$(npm view @skillsmith/cli@$VERSION version 2>/dev/null || echo '')
          if [ -n "$PUBLISHED" ]; then
            echo "cli_exists=true" >> $GITHUB_OUTPUT
            echo "| @skillsmith/cli | $VERSION | $PUBLISHED | â­ï¸ Skip |" >> $GITHUB_STEP_SUMMARY
          else
            echo "cli_exists=false" >> $GITHUB_OUTPUT
            echo "| @skillsmith/cli | $VERSION | - | ðŸ“¦ Publish |" >> $GITHUB_STEP_SUMMARY
            ANY_TO_PUBLISH=true
          fi

          # SMI-1316: Check @smith-horn/enterprise with authenticated GitHub Packages check
          VERSION=$(jq -r .version packages/enterprise/package.json)
          # Configure npm for GitHub Packages auth (using GITHUB_TOKEN)
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> ~/.npmrc
          PUBLISHED=$(npm view @smith-horn/enterprise@$VERSION version --registry=https://npm.pkg.github.com 2>/dev/null || echo '')
          # Clean up npmrc
          rm -f ~/.npmrc
          if [ -n "$PUBLISHED" ]; then
            echo "enterprise_exists=true" >> $GITHUB_OUTPUT
            echo "| @smith-horn/enterprise | $VERSION | $PUBLISHED | â­ï¸ Skip |" >> $GITHUB_STEP_SUMMARY
          else
            echo "enterprise_exists=false" >> $GITHUB_OUTPUT
            echo "| @smith-horn/enterprise | $VERSION | - | ðŸ“¦ Publish |" >> $GITHUB_STEP_SUMMARY
            ANY_TO_PUBLISH=true
          fi

          echo "any_to_publish=$ANY_TO_PUBLISH" >> $GITHUB_OUTPUT

      - name: Validate .npmignore files exist
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Package Configuration Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | .npmignore | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------------|--------|" >> $GITHUB_STEP_SUMMARY

          MISSING=0
          for pkg in packages/*/; do
            PKG_NAME=$(basename "$pkg")
            if [ ! -f "${pkg}.npmignore" ]; then
              echo "::warning file=${pkg}package.json::Missing .npmignore file in $PKG_NAME - test files may be included in package"
              echo "| $PKG_NAME | Missing | âš ï¸ Warning |" >> $GITHUB_STEP_SUMMARY
              MISSING=1
            else
              echo "| $PKG_NAME | Present | âœ… |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          if [ $MISSING -eq 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… All packages have .npmignore files" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Validate package scopes for GitHub Packages
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scope Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')

          for pkg in packages/*/package.json; do
            PKG_NAME=$(jq -r '.name' "$pkg")
            REGISTRY=$(jq -r '.publishConfig.registry // empty' "$pkg")

            if [[ "$REGISTRY" == *"npm.pkg.github.com"* ]]; then
              SCOPE=$(echo "$PKG_NAME" | cut -d'/' -f1 | tr -d '@' | tr '[:upper:]' '[:lower:]')
              if [[ "$SCOPE" != "$OWNER" ]]; then
                echo "::error file=$pkg::Package scope '@$SCOPE' doesn't match org '$OWNER'"
                exit 1
              fi
              echo "âœ… $PKG_NAME scope matches org" >> $GITHUB_STEP_SUMMARY
            fi
          done

      # SMI-2230: Validate package.json and server.json versions match
      - name: Validate version sync (MCP server)
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Version Sync Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          PKG_VERSION=$(jq -r .version packages/mcp-server/package.json)
          SERVER_VERSION=$(jq -r .version packages/mcp-server/server.json)
          SERVER_PKG_VERSION=$(jq -r '.packages[0].version' packages/mcp-server/server.json)

          if [ "$PKG_VERSION" != "$SERVER_VERSION" ]; then
            echo "::error::Version mismatch: package.json ($PKG_VERSION) != server.json ($SERVER_VERSION)"
            echo "âŒ package.json ($PKG_VERSION) != server.json ($SERVER_VERSION)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          if [ "$PKG_VERSION" != "$SERVER_PKG_VERSION" ]; then
            echo "::error::Version mismatch: server.json version ($SERVER_VERSION) != packages[0].version ($SERVER_PKG_VERSION)"
            echo "âŒ server.json version != packages[0].version" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "âœ… MCP server version sync: $PKG_VERSION" >> $GITHUB_STEP_SUMMARY

  # Build Docker image once, use for all jobs (matches ci.yml pattern)
  # SMI-1319: Skip Docker build if nothing to publish
  docker-build:
    needs: pre-publish-check
    if: needs.pre-publish-check.outputs.any-to-publish == 'true'
    name: Build Docker Image
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and cache Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: skillsmith-publish:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          target: dev

      - name: Save Docker image
        run: docker save skillsmith-publish:${{ github.sha }} | gzip > /tmp/skillsmith-publish.tar.gz

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        continue-on-error: true # Don't fail if storage quota exceeded
        with:
          name: docker-image-publish
          path: /tmp/skillsmith-publish.tar.gz
          retention-days: 1

      - name: Extract node_modules from Docker image
        run: |
          docker create --name extract-deps skillsmith-publish:${{ github.sha }}
          docker cp extract-deps:/app/node_modules /tmp/node_modules
          docker rm extract-deps
          tar -czf /tmp/node_modules.tar.gz -C /tmp node_modules

      - name: Upload node_modules artifact
        uses: actions/upload-artifact@v4
        continue-on-error: true # Don't fail if storage quota exceeded
        with:
          name: node-modules-publish
          path: /tmp/node_modules.tar.gz
          retention-days: 1
          compression-level: 1

  # Validate before publishing (using Docker)
  # SMI-1319: Skip validation if nothing to publish
  validate:
    name: Validate
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [pre-publish-check, docker-build]
    if: needs.pre-publish-check.outputs.any-to-publish == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Docker image
        uses: actions/download-artifact@v4
        id: download-docker
        continue-on-error: true
        with:
          name: docker-image-publish
          path: /tmp

      - name: Download node_modules
        uses: actions/download-artifact@v4
        id: download-modules
        continue-on-error: true
        with:
          name: node-modules-publish
          path: /tmp

      - name: Setup Node.js (fallback if no artifacts)
        if: steps.download-docker.outcome == 'failure'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies (fallback if no artifacts)
        if: steps.download-docker.outcome == 'failure'
        run: npm ci

      - name: Load Docker image
        if: steps.download-docker.outcome == 'success'
        run: gunzip -c /tmp/skillsmith-publish.tar.gz | docker load

      - name: Extract node_modules
        if: steps.download-modules.outcome == 'success'
        run: tar -xzf /tmp/node_modules.tar.gz -C ${{ github.workspace }}

      - name: Build all packages (Docker)
        if: steps.download-docker.outcome == 'success'
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/app \
            -w /app \
            skillsmith-publish:${{ github.sha }} \
            npm run build

      - name: Build all packages (fallback)
        if: steps.download-docker.outcome == 'failure'
        run: npm run build

      - name: Run tests (Docker)
        if: steps.download-docker.outcome == 'success'
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/app \
            -w /app \
            skillsmith-publish:${{ github.sha }} \
            npm test

      - name: Run tests (fallback)
        if: steps.download-docker.outcome == 'failure'
        run: npm test

      - name: Type check (Docker)
        if: steps.download-docker.outcome == 'success'
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/app \
            -w /app \
            skillsmith-publish:${{ github.sha }} \
            npm run typecheck

      - name: Type check (fallback)
        if: steps.download-docker.outcome == 'failure'
        run: npm run typecheck

      - name: Lint (Docker)
        if: steps.download-docker.outcome == 'success'
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/app \
            -w /app \
            skillsmith-publish:${{ github.sha }} \
            npm run lint

      - name: Lint (fallback)
        if: steps.download-docker.outcome == 'failure'
        run: npm run lint

  # Publish free tier packages to public npm
  # Note: npm publish requires direct npm ci for registry authentication
  # SMI-1278: Added version check to prevent 403 errors on duplicate publish
  # SMI-1319: Use pre-publish-check outputs to skip already-published packages
  publish-core:
    name: Publish @skillsmith/core
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [pre-publish-check, validate]
    if: |
      (github.event_name == 'release' || github.event.inputs.dry_run == 'false') &&
      needs.pre-publish-check.outputs.core-exists != 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build core package
        run: npm run build -w @skillsmith/core

      - name: Check if version already published
        id: version-check
        run: |
          PACKAGE_VERSION=$(node -p "require('./packages/core/package.json').version")
          NPM_VERSION=$(npm view @skillsmith/core version 2>/dev/null || echo 'not-found')
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "npm_version=$NPM_VERSION" >> $GITHUB_OUTPUT
          if [ "$PACKAGE_VERSION" = "$NPM_VERSION" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "::notice::@skillsmith/core@$PACKAGE_VERSION already published, skipping..."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::notice::Publishing @skillsmith/core@$PACKAGE_VERSION (current npm: $NPM_VERSION)"
          fi

      - name: Publish core
        if: steps.version-check.outputs.exists != 'true'
        run: npm publish -w @skillsmith/core --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.SKILLSMITH_NPM_TOKEN }}

  # SMI-1319: Use pre-publish-check outputs to skip already-published packages
  publish-mcp-server:
    name: Publish @skillsmith/mcp-server
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [pre-publish-check, validate, publish-core]
    if: |
      always() &&
      (github.event_name == 'release' || github.event.inputs.dry_run == 'false') &&
      needs.pre-publish-check.outputs.mcp-exists != 'true' &&
      (needs.publish-core.result == 'success' || needs.publish-core.result == 'skipped')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build packages
        run: npm run build

      - name: Check if version already published
        id: version-check
        run: |
          PACKAGE_VERSION=$(node -p "require('./packages/mcp-server/package.json').version")
          NPM_VERSION=$(npm view @skillsmith/mcp-server version 2>/dev/null || echo 'not-found')
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "npm_version=$NPM_VERSION" >> $GITHUB_OUTPUT
          if [ "$PACKAGE_VERSION" = "$NPM_VERSION" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "::notice::@skillsmith/mcp-server@$PACKAGE_VERSION already published, skipping..."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::notice::Publishing @skillsmith/mcp-server@$PACKAGE_VERSION (current npm: $NPM_VERSION)"
          fi

      - name: Publish mcp-server
        if: steps.version-check.outputs.exists != 'true'
        run: npm publish -w @skillsmith/mcp-server --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.SKILLSMITH_NPM_TOKEN }}

      # SMI-2158: Publish to MCP Registry after npm publish
      - name: Install mcp-publisher
        if: steps.version-check.outputs.exists != 'true'
        run: |
          curl -L "https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_linux_amd64.tar.gz" | tar xz
          chmod +x mcp-publisher

      - name: Publish to MCP Registry
        if: steps.version-check.outputs.exists != 'true'
        run: |
          cd packages/mcp-server
          ../../mcp-publisher publish
        env:
          MCP_REGISTRY_TOKEN: ${{ secrets.MCP_REGISTRY_TOKEN }}

  # SMI-1319: Use pre-publish-check outputs to skip already-published packages
  publish-cli:
    name: Publish @skillsmith/cli
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [pre-publish-check, validate, publish-core]
    if: |
      always() &&
      (github.event_name == 'release' || github.event.inputs.dry_run == 'false') &&
      needs.pre-publish-check.outputs.cli-exists != 'true' &&
      (needs.publish-core.result == 'success' || needs.publish-core.result == 'skipped')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build packages
        run: npm run build

      - name: Check if version already published
        id: version-check
        run: |
          PACKAGE_VERSION=$(node -p "require('./packages/cli/package.json').version")
          NPM_VERSION=$(npm view @skillsmith/cli version 2>/dev/null || echo 'not-found')
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "npm_version=$NPM_VERSION" >> $GITHUB_OUTPUT
          if [ "$PACKAGE_VERSION" = "$NPM_VERSION" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "::notice::@skillsmith/cli@$PACKAGE_VERSION already published, skipping..."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::notice::Publishing @skillsmith/cli@$PACKAGE_VERSION (current npm: $NPM_VERSION)"
          fi

      - name: Publish cli
        if: steps.version-check.outputs.exists != 'true'
        run: npm publish -w @skillsmith/cli --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.SKILLSMITH_NPM_TOKEN }}

  # Publish enterprise package to GitHub Packages (private)
  # SMI-1319: Use pre-publish-check outputs to skip already-published packages
  publish-enterprise:
    name: Publish @smith-horn/enterprise
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [pre-publish-check, validate, publish-core]
    if: |
      always() &&
      (github.event_name == 'release' || github.event.inputs.dry_run == 'false') &&
      needs.pre-publish-check.outputs.enterprise-exists != 'true' &&
      (needs.publish-core.result == 'success' || needs.publish-core.result == 'skipped')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js for GitHub Packages
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://npm.pkg.github.com'
          scope: '@smith-horn'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build packages
        run: npm run build

      # Note: GITHUB_TOKEN needs packages:read scope for version check
      - name: Check if version already published
        id: version-check
        run: |
          PACKAGE_VERSION=$(node -p "require('./packages/enterprise/package.json').version")
          # GitHub Packages uses different registry - check there
          NPM_VERSION=$(npm view @smith-horn/enterprise version --registry=https://npm.pkg.github.com 2>/dev/null || echo 'not-found')
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "npm_version=$NPM_VERSION" >> $GITHUB_OUTPUT
          if [ "$PACKAGE_VERSION" = "$NPM_VERSION" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "::notice::@smith-horn/enterprise@$PACKAGE_VERSION already published, skipping..."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::notice::Publishing @smith-horn/enterprise@$PACKAGE_VERSION (current registry: $NPM_VERSION)"
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish enterprise to GitHub Packages
        if: steps.version-check.outputs.exists != 'true'
        run: npm publish -w @smith-horn/enterprise
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # SMI-2230: Smoke test published packages
  smoke-test:
    name: Smoke Test Published Packages
    runs-on: ubuntu-latest
    needs: [publish-core, publish-mcp-server, publish-cli]
    if: always() && (needs.publish-core.result == 'success' || needs.publish-mcp-server.result == 'success' || needs.publish-cli.result == 'success')
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Wait for npm propagation
        run: sleep 15

      - name: Smoke test @skillsmith/core
        if: needs.publish-core.result == 'success'
        run: |
          echo "## Smoke Test: @skillsmith/core" >> $GITHUB_STEP_SUMMARY
          VERSION=$(jq -r .version packages/core/package.json)
          npx tsx scripts/smoke-test-published.ts @skillsmith/core $VERSION
          echo "âœ… @skillsmith/core@$VERSION smoke test passed" >> $GITHUB_STEP_SUMMARY

      - name: Smoke test @skillsmith/mcp-server
        if: needs.publish-mcp-server.result == 'success'
        run: |
          echo "## Smoke Test: @skillsmith/mcp-server" >> $GITHUB_STEP_SUMMARY
          VERSION=$(jq -r .version packages/mcp-server/package.json)
          npx tsx scripts/smoke-test-published.ts @skillsmith/mcp-server $VERSION
          echo "âœ… @skillsmith/mcp-server@$VERSION smoke test passed" >> $GITHUB_STEP_SUMMARY

      - name: Smoke test @skillsmith/cli
        if: needs.publish-cli.result == 'success'
        run: |
          echo "## Smoke Test: @skillsmith/cli" >> $GITHUB_STEP_SUMMARY
          VERSION=$(jq -r .version packages/cli/package.json)
          npx tsx scripts/smoke-test-published.ts @skillsmith/cli $VERSION
          echo "âœ… @skillsmith/cli@$VERSION smoke test passed" >> $GITHUB_STEP_SUMMARY

  # Summary job
  publish-summary:
    name: Publish Summary
    runs-on: ubuntu-latest
    needs: [publish-core, publish-mcp-server, publish-cli, publish-enterprise, smoke-test]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "## Publish Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Status | Smoke Test |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|------------|" >> $GITHUB_STEP_SUMMARY
          echo "| @skillsmith/core | ${{ needs.publish-core.result }} | ${{ needs.smoke-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| @skillsmith/mcp-server | ${{ needs.publish-mcp-server.result }} | ${{ needs.smoke-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| @skillsmith/cli | ${{ needs.publish-cli.result }} | ${{ needs.smoke-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| @smith-horn/enterprise | ${{ needs.publish-enterprise.result }} | N/A |" >> $GITHUB_STEP_SUMMARY
