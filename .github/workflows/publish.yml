# SMI-1251: Aligned with Docker-first CI strategy
name: Publish Packages

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no actual publish)'
        required: false
        default: 'true'
        type: boolean

# Required for GitHub Packages publishing
permissions:
  contents: read
  packages: write

concurrency:
  group: publish-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: '22'
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # Build Docker image once, use for all jobs (matches ci.yml pattern)
  docker-build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and cache Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: skillsmith-publish:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          target: dev

      - name: Save Docker image
        run: docker save skillsmith-publish:${{ github.sha }} | gzip > /tmp/skillsmith-publish.tar.gz

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-publish
          path: /tmp/skillsmith-publish.tar.gz
          retention-days: 1

      - name: Extract node_modules from Docker image
        run: |
          docker create --name extract-deps skillsmith-publish:${{ github.sha }}
          docker cp extract-deps:/app/node_modules /tmp/node_modules
          docker rm extract-deps
          tar -czf /tmp/node_modules.tar.gz -C /tmp node_modules

      - name: Upload node_modules artifact
        uses: actions/upload-artifact@v4
        with:
          name: node-modules-publish
          path: /tmp/node_modules.tar.gz
          retention-days: 1
          compression-level: 1

  # Validate before publishing (using Docker)
  validate:
    name: Validate
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: docker-build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image-publish
          path: /tmp

      - name: Download node_modules
        uses: actions/download-artifact@v4
        with:
          name: node-modules-publish
          path: /tmp

      - name: Load Docker image
        run: gunzip -c /tmp/skillsmith-publish.tar.gz | docker load

      - name: Extract node_modules
        run: tar -xzf /tmp/node_modules.tar.gz -C ${{ github.workspace }}

      - name: Build all packages in Docker
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/app \
            -w /app \
            skillsmith-publish:${{ github.sha }} \
            npm run build

      - name: Run tests in Docker
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/app \
            -w /app \
            skillsmith-publish:${{ github.sha }} \
            npm test

      - name: Type check in Docker
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/app \
            -w /app \
            skillsmith-publish:${{ github.sha }} \
            npm run typecheck

      - name: Lint in Docker
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/app \
            -w /app \
            skillsmith-publish:${{ github.sha }} \
            npm run lint

  # Publish free tier packages to public npm
  # Note: npm publish requires direct npm ci for registry authentication
  # SMI-1278: Added version check to prevent 403 errors on duplicate publish
  publish-core:
    name: Publish @skillsmith/core
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: validate
    if: github.event_name == 'release' || github.event.inputs.dry_run == 'false'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build core package
        run: npm run build -w @skillsmith/core

      - name: Check if version already published
        id: version-check
        run: |
          PACKAGE_VERSION=$(node -p "require('./packages/core/package.json').version")
          NPM_VERSION=$(npm view @skillsmith/core version 2>/dev/null || echo 'not-found')
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "npm_version=$NPM_VERSION" >> $GITHUB_OUTPUT
          if [ "$PACKAGE_VERSION" = "$NPM_VERSION" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "::notice::@skillsmith/core@$PACKAGE_VERSION already published, skipping..."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::notice::Publishing @skillsmith/core@$PACKAGE_VERSION (current npm: $NPM_VERSION)"
          fi

      - name: Publish core
        if: steps.version-check.outputs.exists != 'true'
        run: npm publish -w @skillsmith/core --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.SKILLSMITH_NPM_TOKEN }}

  publish-mcp-server:
    name: Publish @skillsmith/mcp-server
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [validate, publish-core]
    if: github.event_name == 'release' || github.event.inputs.dry_run == 'false'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build packages
        run: npm run build

      - name: Check if version already published
        id: version-check
        run: |
          PACKAGE_VERSION=$(node -p "require('./packages/mcp-server/package.json').version")
          NPM_VERSION=$(npm view @skillsmith/mcp-server version 2>/dev/null || echo 'not-found')
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "npm_version=$NPM_VERSION" >> $GITHUB_OUTPUT
          if [ "$PACKAGE_VERSION" = "$NPM_VERSION" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "::notice::@skillsmith/mcp-server@$PACKAGE_VERSION already published, skipping..."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::notice::Publishing @skillsmith/mcp-server@$PACKAGE_VERSION (current npm: $NPM_VERSION)"
          fi

      - name: Publish mcp-server
        if: steps.version-check.outputs.exists != 'true'
        run: npm publish -w @skillsmith/mcp-server --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.SKILLSMITH_NPM_TOKEN }}

  publish-cli:
    name: Publish @skillsmith/cli
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [validate, publish-core]
    if: github.event_name == 'release' || github.event.inputs.dry_run == 'false'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build packages
        run: npm run build

      - name: Check if version already published
        id: version-check
        run: |
          PACKAGE_VERSION=$(node -p "require('./packages/cli/package.json').version")
          NPM_VERSION=$(npm view @skillsmith/cli version 2>/dev/null || echo 'not-found')
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "npm_version=$NPM_VERSION" >> $GITHUB_OUTPUT
          if [ "$PACKAGE_VERSION" = "$NPM_VERSION" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "::notice::@skillsmith/cli@$PACKAGE_VERSION already published, skipping..."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::notice::Publishing @skillsmith/cli@$PACKAGE_VERSION (current npm: $NPM_VERSION)"
          fi

      - name: Publish cli
        if: steps.version-check.outputs.exists != 'true'
        run: npm publish -w @skillsmith/cli --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.SKILLSMITH_NPM_TOKEN }}

  # Publish enterprise package to GitHub Packages (private)
  publish-enterprise:
    name: Publish @skillsmith/enterprise
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [validate, publish-core]
    if: github.event_name == 'release' || github.event.inputs.dry_run == 'false'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js for GitHub Packages
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://npm.pkg.github.com'
          scope: '@skillsmith'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build packages
        run: npm run build

      # Note: GITHUB_TOKEN needs packages:read scope for version check
      - name: Check if version already published
        id: version-check
        run: |
          PACKAGE_VERSION=$(node -p "require('./packages/enterprise/package.json').version")
          # GitHub Packages uses different registry - check there
          NPM_VERSION=$(npm view @skillsmith/enterprise version --registry=https://npm.pkg.github.com 2>/dev/null || echo 'not-found')
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "npm_version=$NPM_VERSION" >> $GITHUB_OUTPUT
          if [ "$PACKAGE_VERSION" = "$NPM_VERSION" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "::notice::@skillsmith/enterprise@$PACKAGE_VERSION already published, skipping..."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::notice::Publishing @skillsmith/enterprise@$PACKAGE_VERSION (current registry: $NPM_VERSION)"
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish enterprise to GitHub Packages
        if: steps.version-check.outputs.exists != 'true'
        run: npm publish -w @skillsmith/enterprise
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Summary job
  publish-summary:
    name: Publish Summary
    runs-on: ubuntu-latest
    needs: [publish-core, publish-mcp-server, publish-cli, publish-enterprise]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "## Publish Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| @skillsmith/core | ${{ needs.publish-core.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| @skillsmith/mcp-server | ${{ needs.publish-mcp-server.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| @skillsmith/cli | ${{ needs.publish-cli.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| @skillsmith/enterprise | ${{ needs.publish-enterprise.result }} |" >> $GITHUB_STEP_SUMMARY
