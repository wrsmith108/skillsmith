---
import BaseLayout from './BaseLayout.astro';
import ImageLightbox from '../components/ImageLightbox.astro';
import { formatDate } from '../utils/blog';

interface Props {
  title: string;
  description?: string | undefined;
  author?: string | undefined;
  date?: Date | undefined;
  updated?: Date | undefined;
  category?: string | undefined;
  tags?: string[] | undefined;
  ogImage?: string | undefined;
  readingTime?: number | undefined;
}

const {
  title,
  description = 'Skillsmith Blog',
  author = 'Skillsmith Team',
  date,
  updated,
  category,
  tags = [],
  ogImage,
  readingTime,
} = Astro.props;

const formattedDate = date ? formatDate(date) : null;
const formattedUpdated = updated ? formatDate(updated) : null;
---

<BaseLayout title={`${title} | Skillsmith Blog`} description={description}>
  <!-- SEO and Open Graph tags for blog posts -->
  <Fragment slot="head">
    <link rel="canonical" href={Astro.url.href} />
    <meta property="og:type" content="article" />
    {date && <meta property="article:published_time" content={date.toISOString()} />}
    {updated && <meta property="article:modified_time" content={updated.toISOString()} />}
    {author && <meta property="article:author" content={author} />}
    {category && <meta property="article:section" content={category} />}
    {tags.map(tag => <meta property="article:tag" content={tag} />)}
    {ogImage && <meta property="og:image" content={ogImage} />}
    {ogImage && <meta name="twitter:image" content={ogImage} />}
    <slot name="head" />
  </Fragment>

  <div class="flex min-h-[calc(100vh-4rem)]">
    <!-- Main Content -->
    <main class="flex-1 min-w-0 px-4 py-10 sm:px-8 lg:px-12">
      <article class="blog-content max-w-2xl mx-auto">
        <!-- Back to blog link -->
        <a href="/blog" class="inline-flex items-center gap-2 text-dark-400 hover:text-primary-500 transition-colors mb-8 group">
          <svg class="w-4 h-4 transition-transform group-hover:-translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          Back to Blog
        </a>

        <!-- Article Header -->
        <header class="mb-10">
          {category && (
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-primary-500/10 text-primary-400 mb-4">
              {category}
            </span>
          )}

          <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-white mb-4 leading-tight">
            {title}
          </h1>

          {description && (
            <p class="text-lg sm:text-xl text-dark-300 mb-6">
              {description}
            </p>
          )}

          <div class="flex flex-wrap items-center gap-4 text-sm text-dark-400">
            {author && (
              <span class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                {author}
              </span>
            )}

            {formattedDate && date && (
              <time datetime={date.toISOString()} class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                {formattedDate}
              </time>
            )}

            {readingTime && (
              <span class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                {readingTime} min read
              </span>
            )}
          </div>

          {formattedUpdated && formattedUpdated !== formattedDate && (
            <p class="mt-3 text-sm text-dark-500">
              Updated: {formattedUpdated}
            </p>
          )}
        </header>

        <!-- Article Content -->
        <div class="prose-content">
          <slot />
        </div>

        <!-- Image Lightbox Component -->
        <ImageLightbox />

        <!-- Tags -->
        {tags.length > 0 && (
          <footer class="mt-12 pt-8 border-t border-dark-800">
            <div class="flex flex-wrap gap-2">
              {tags.map((tag) => (
                <span class="px-3 py-1 text-sm bg-dark-800 text-dark-300 rounded-full">
                  #{tag}
                </span>
              ))}
            </div>
          </footer>
        )}
      </article>
    </main>

    <!-- Table of Contents -->
    <aside class="hidden xl:block w-64 shrink-0 py-10 pr-8">
      <div class="sticky top-24">
        <h4 class="text-xs font-semibold uppercase tracking-wider text-dark-500 mb-4">On this page</h4>
        <nav class="toc-nav" id="toc" aria-label="Table of contents">
          <!-- Generated by JavaScript -->
        </nav>
      </div>
    </aside>
  </div>

  <script>
    // Generate table of contents from headings
    document.addEventListener('DOMContentLoaded', () => {
      const article = document.querySelector('.prose-content');
      const toc = document.getElementById('toc');

      if (!article || !toc) return;

      const headings = article.querySelectorAll('h2, h3');
      if (headings.length === 0) return;

      const ul = document.createElement('ul');
      ul.className = 'space-y-2';

      headings.forEach((heading, index) => {
        if (!heading.id) {
          heading.id = `heading-${index}`;
        }

        const li = document.createElement('li');
        li.className = heading.tagName === 'H3' ? 'pl-3' : '';

        const a = document.createElement('a');
        a.href = `#${heading.id}`;
        a.className = 'text-sm text-dark-400 hover:text-primary-400 transition-colors block py-1';
        a.textContent = heading.textContent;

        li.appendChild(a);
        ul.appendChild(li);
      });

      toc.appendChild(ul);
    });
  </script>
</BaseLayout>

<style is:global>
  /* Blog Content Styles */
  .prose-content {
    color: #cbd5e1;
    line-height: 1.75;
  }

  .prose-content h2 {
    font-size: 1.875rem;
    font-weight: 600;
    color: white;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
  }

  .prose-content h2:first-of-type {
    margin-top: 0;
  }

  .prose-content h3 {
    font-size: 1.5rem;
    font-weight: 600;
    color: white;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
  }

  .prose-content h4 {
    font-size: 1.25rem;
    font-weight: 600;
    color: #e2e8f0;
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .prose-content p {
    margin-bottom: 1.25rem;
  }

  .prose-content ul,
  .prose-content ol {
    margin-bottom: 1.25rem;
    padding-left: 1.5rem;
  }

  .prose-content ul {
    list-style-type: disc;
  }

  .prose-content ol {
    list-style-type: decimal;
  }

  .prose-content li {
    margin-bottom: 0.5rem;
  }

  .prose-content a {
    color: #E07A5F;
    text-decoration: underline;
    text-underline-offset: 2px;
    transition: color 0.2s;
  }

  .prose-content a:hover {
    color: #f09080;
  }

  .prose-content strong {
    color: #f1f5f9;
    font-weight: 600;
  }

  .prose-content code {
    font-family: ui-monospace, 'JetBrains Mono', monospace;
    font-size: 0.875rem;
    background-color: #1e293b;
    color: #7dd3fc;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
  }

  .prose-content pre {
    background-color: #0f172a;
    border: 1px solid #1e293b;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1.5rem;
    overflow-x: auto;
  }

  .prose-content pre code {
    background-color: transparent;
    padding: 0;
    color: #e2e8f0;
  }

  .prose-content blockquote {
    border-left: 4px solid #E07A5F;
    padding-left: 1.25rem;
    margin: 1.5rem 0;
    font-style: italic;
    color: #94a3b8;
  }

  .prose-content img {
    max-width: 100%;
    height: auto;
    border-radius: 0.5rem;
    margin: 2rem 0;
    border: 1px solid #1e293b;
    cursor: zoom-in;
    transition: opacity 0.2s ease, box-shadow 0.2s ease;
  }

  .prose-content img:hover {
    opacity: 0.9;
    box-shadow: 0 0 0 2px rgba(224, 122, 95, 0.3);
  }

  .prose-content img:focus {
    outline: none;
    box-shadow: 0 0 0 2px #E07A5F;
  }

  .prose-content img:focus-visible {
    outline: 2px solid #E07A5F;
    outline-offset: 2px;
  }

  /* Table wrapper for horizontal scroll on mobile */
  .prose-content .table-wrapper {
    position: relative;
    overflow-x: auto;
    margin: 1.5rem 0;
    -webkit-overflow-scrolling: touch;
  }

  .prose-content .table-wrapper::after {
    content: '';
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    width: 24px;
    background: linear-gradient(to right, transparent, rgba(13, 13, 15, 0.8));
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .prose-content .table-wrapper.has-scroll::after {
    opacity: 1;
  }

  .prose-content table {
    width: 100%;
    font-size: 0.875rem;
    border-collapse: collapse;
  }

  .prose-content th {
    text-align: left;
    font-weight: 600;
    color: #e2e8f0;
    background-color: #0f172a;
    padding: 0.75rem 1rem;
    border: 1px solid #1e293b;
  }

  .prose-content td {
    color: #cbd5e1;
    padding: 0.75rem 1rem;
    border: 1px solid #1e293b;
  }

  .prose-content hr {
    border: none;
    border-top: 1px solid #1e293b;
    margin: 2.5rem 0;
  }

  /* Superscript footnotes */
  .prose-content sup {
    font-size: 0.75rem;
    color: #E07A5F;
  }

  .prose-content sup a {
    text-decoration: none;
  }

  /* Horizontal rule styling */
  .prose-content hr + h2 {
    border-top: none;
    padding-top: 0;
  }
</style>
