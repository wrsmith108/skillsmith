---
/**
 * Skillsmith Login Page
 *
 * SMI-1168: User registration and login
 * SMI-1715: GitHub OAuth authentication
 *
 * Handles email/password login and GitHub OAuth with Supabase Auth.
 * Redirects to account dashboard on success.
 */

// Disable prerendering - this page needs SSR to read env vars
export const prerender = false;

import { getSupabaseConfig } from '../lib/supabase-config';
import LoginButton from '../components/auth/LoginButton.astro';

// Read env vars at SSR time to inject into client script
const supabaseConfig = getSupabaseConfig();

// Get redirect URL from query params
const redirectTo = Astro.url.searchParams.get('redirect') || '/account';
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/logo-icon.svg" />

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GGZQZM1Y1L"></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-GGZQZM1Y1L');
    </script>

    <meta name="description" content="Sign in to your Skillsmith account to manage skills, view your subscription, and access your dashboard." />
    <title>Sign In | Skillsmith</title>
    <link rel="preconnect" href="https://api.fontshare.com" crossorigin />
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@300,400,500,700,900&display=swap" rel="stylesheet" />
    <script is:inline define:vars={{ supabaseConfig }}>
      window.__SUPABASE_CONFIG__ = supabaseConfig;
    </script>
  </head>
  <body>
    <header class="header">
      <nav class="nav">
        <a href="/" class="logo">
          <!-- Neural S Icon -->
          <svg width="32" height="32" viewBox="0 0 64 64" class="logo-icon-svg">
            <rect width="64" height="64" fill="transparent" rx="8"/>
            <g transform="translate(32, 32)">
              <path d="M 10 -18 Q -10 -14, -10 -4 Q -10 4, 10 8 Q 10 16, -10 20"
                    stroke="currentColor" stroke-width="1.5" stroke-opacity="0.3" fill="none"/>
              <circle cx="10" cy="-18" r="5" fill="#E07A5F"/>
              <circle cx="-10" cy="-4" r="5" fill="#E07A5F"/>
              <circle cx="10" cy="8" r="5" fill="#E07A5F"/>
              <circle cx="-10" cy="20" r="5" fill="#E07A5F"/>
            </g>
          </svg>
          <span class="logo-text">Skillsmith</span>
        </a>
        <div class="nav-links">
          <a href="/features">Features</a>
          <a href="/pricing">Pricing</a>
          <a href="/docs">Docs</a>
        </div>
      </nav>
    </header>

    <main class="auth-container">
      <div class="auth-card">
        <div class="auth-header">
          <h1>Welcome back</h1>
          <p>Sign in to your Skillsmith account</p>
        </div>

        <form id="login-form" class="auth-form">
          <div class="form-group">
            <label for="email">Email</label>
            <input
              type="email"
              id="email"
              name="email"
              placeholder="you@example.com"
              required
              autocomplete="email"
            />
          </div>

          <div class="form-group">
            <label for="password">
              Password
              <a href="/auth/forgot-password" class="forgot-link">Forgot?</a>
            </label>
            <input
              type="password"
              id="password"
              name="password"
              placeholder="Enter your password"
              required
              autocomplete="current-password"
              minlength="8"
            />
          </div>

          <div id="error-message" class="error-message" style="display: none;"></div>
          <div id="success-message" class="success-message" style="display: none;"></div>

          <button type="submit" class="btn btn-primary btn-full" id="submit-btn">
            <span class="btn-text">Sign In</span>
            <span class="btn-loading" style="display: none;">
              <svg class="spinner" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" opacity="0.25"/>
                <path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="4" fill="none"/>
              </svg>
              Signing in...
            </span>
          </button>
        </form>

        <div class="auth-divider">
          <span>or continue with</span>
        </div>

        <div class="social-login">
          <LoginButton variant="primary" size="md" redirectTo={redirectTo} />
        </div>

        <div class="auth-alternate">
          <p>Don't have an account? <a href="/signup">Sign up</a></p>
        </div>
      </div>

      <div class="auth-footer">
        <p>By signing in, you agree to our <a href="/terms">Terms of Service</a> and <a href="/privacy">Privacy Policy</a>.</p>
      </div>
    </main>

    <footer class="footer">
      <div class="footer-content">
        <p>&copy; 2026 Smith Horn Group Ltd. All rights reserved.</p>
        <p class="license-note">Licensed under <a href="https://www.elastic.co/licensing/elastic-license">Elastic License 2.0</a></p>
      </div>
    </footer>
  </body>
</html>

<style>
  /* Reset and base styles */
  *,
  *::before,
  *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  html {
    font-size: 16px;
  }

  body {
    font-family: 'Satoshi', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    line-height: 1.6;
    color: #FAFAFA;
    background: #0D0D0F;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* Header */
  .header {
    background: rgba(13, 13, 15, 0.95);
    backdrop-filter: blur(8px);
    border-bottom: 1px solid #1f1f23;
  }

  .nav {
    max-width: 1280px;
    margin: 0 auto;
    padding: 1rem 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 2rem;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    font-weight: 700;
    font-size: 1.25rem;
    color: #FAFAFA;
  }

  .nav-links {
    display: flex;
    gap: 2rem;
  }

  .nav-links a {
    text-decoration: none;
    color: #9ca3af;
    font-weight: 500;
    transition: color 0.2s;
  }

  .nav-links a:hover {
    color: #E07A5F;
  }

  /* Auth Container */
  .auth-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }

  .auth-card {
    width: 100%;
    max-width: 400px;
    background: #121214;
    border-radius: 1rem;
    padding: 2rem;
    border: 1px solid #2a2a2f;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
  }

  .auth-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .auth-header h1 {
    font-size: 1.75rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }

  .auth-header p {
    color: #9ca3af;
  }

  /* Form Styles */
  .auth-form {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-group label {
    font-size: 0.875rem;
    font-weight: 500;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .forgot-link {
    font-size: 0.75rem;
    color: #E07A5F;
    text-decoration: none;
    font-weight: 400;
  }

  .forgot-link:hover {
    text-decoration: underline;
  }

  .form-group input {
    padding: 0.75rem 1rem;
    font-size: 1rem;
    border: 1px solid #2a2a2f;
    border-radius: 0.5rem;
    background: #1a1a1f;
    color: #FAFAFA;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .form-group input::placeholder {
    color: #6b7280;
  }

  .form-group input:focus {
    outline: none;
    border-color: #E07A5F;
    box-shadow: 0 0 0 3px rgba(224, 122, 95, 0.1);
  }

  /* Error/Success Messages */
  .error-message {
    background: rgba(220, 38, 38, 0.1);
    border: 1px solid rgba(220, 38, 38, 0.3);
    color: #f87171;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
  }

  .success-message {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.3);
    color: #34d399;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
  }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
    font-weight: 600;
    text-decoration: none;
    border-radius: 0.5rem;
    transition: all 0.2s;
    cursor: pointer;
    border: none;
  }

  .btn-primary {
    background: linear-gradient(135deg, #E07A5F 0%, #D4694E 100%);
    color: white;
  }

  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(224, 122, 95, 0.4);
  }

  .btn-primary:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
  }

  .btn-full {
    width: 100%;
  }

  /* Loading Spinner */
  .spinner {
    width: 1.25rem;
    height: 1.25rem;
    margin-right: 0.5rem;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* Divider */
  .auth-divider {
    display: flex;
    align-items: center;
    margin: 1.5rem 0;
    gap: 1rem;
  }

  .auth-divider::before,
  .auth-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: #2a2a2f;
  }

  .auth-divider span {
    color: #6b7280;
    font-size: 0.875rem;
    text-transform: lowercase;
  }

  /* Social Login */
  .social-login {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .social-login :global(.github-login-btn) {
    width: 100%;
  }

  /* Alternate Action */
  .auth-alternate {
    text-align: center;
    margin-top: 1.5rem;
  }

  .auth-alternate p {
    color: #9ca3af;
    font-size: 0.875rem;
  }

  .auth-alternate a {
    color: #E07A5F;
    text-decoration: none;
    font-weight: 500;
  }

  .auth-alternate a:hover {
    text-decoration: underline;
  }

  /* Auth Footer */
  .auth-footer {
    margin-top: 1.5rem;
    text-align: center;
    max-width: 400px;
  }

  .auth-footer p {
    font-size: 0.75rem;
    color: #6b7280;
  }

  .auth-footer a {
    color: #9ca3af;
    text-decoration: none;
  }

  .auth-footer a:hover {
    text-decoration: underline;
  }

  /* Footer */
  .footer {
    margin-top: auto;
    background: #1a1a2e;
    color: white;
    padding: 2rem;
  }

  .footer-content {
    max-width: 1280px;
    margin: 0 auto;
    text-align: center;
    font-size: 0.875rem;
    color: #9ca3af;
  }

  .license-note a {
    color: #9ca3af;
    text-decoration: underline;
  }

  .license-note a:hover {
    color: white;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .nav-links {
      display: none;
    }

    .auth-container {
      padding: 1.5rem 1rem;
    }

    .auth-card {
      padding: 1.5rem;
    }
  }
</style>

<script>
  import { createClient } from '@supabase/supabase-js'

  // Initialize Supabase client
  // Read config injected by SSR script in head
  const config = window.__SUPABASE_CONFIG__ || { url: '', anonKey: '' };
  const supabaseUrl = config.url;
  const supabaseAnonKey = config.anonKey;

  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('login-form') as HTMLFormElement
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement
    const errorMessage = document.getElementById('error-message') as HTMLDivElement
    const successMessage = document.getElementById('success-message') as HTMLDivElement

    // Check if already logged in
    if (supabaseUrl && supabaseAnonKey) {
      const supabase = createClient(supabaseUrl, supabaseAnonKey)
      supabase.auth.getSession().then(({ data: { session } }) => {
        if (session) {
          // Already logged in, redirect to account
          const redirectTo = new URLSearchParams(window.location.search).get('redirect') || '/account'
          window.location.href = redirectTo
        }
      })
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault()

      // Reset messages
      errorMessage.style.display = 'none'
      successMessage.style.display = 'none'

      // Show loading state
      const btnText = submitBtn.querySelector('.btn-text') as HTMLSpanElement
      const btnLoading = submitBtn.querySelector('.btn-loading') as HTMLSpanElement
      btnText.style.display = 'none'
      btnLoading.style.display = 'inline-flex'
      submitBtn.disabled = true

      try {
        if (!supabaseUrl || !supabaseAnonKey) {
          throw new Error('Authentication service not configured')
        }

        const supabase = createClient(supabaseUrl, supabaseAnonKey)
        const formData = new FormData(form)
        const email = formData.get('email') as string
        const password = formData.get('password') as string

        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password,
        })

        if (error) {
          if (error.message.includes('Email not confirmed')) {
            errorMessage.textContent = 'Please verify your email before logging in. Check your inbox for the verification link.'
          } else if (error.message.includes('Invalid login credentials')) {
            errorMessage.textContent = 'Invalid email or password. Please try again.'
          } else {
            errorMessage.textContent = error.message
          }
          errorMessage.style.display = 'block'
          return
        }

        if (data.session) {
          successMessage.textContent = 'Login successful! Redirecting...'
          successMessage.style.display = 'block'

          // Redirect after short delay
          const redirectTo = new URLSearchParams(window.location.search).get('redirect') || '/account'
          setTimeout(() => {
            window.location.href = redirectTo
          }, 500)
        }
      } catch (error) {
        console.error('Login error:', error)
        errorMessage.textContent = error instanceof Error ? error.message : 'An error occurred. Please try again.'
        errorMessage.style.display = 'block'
      } finally {
        // Reset button state
        btnText.style.display = 'inline'
        btnLoading.style.display = 'none'
        submitBtn.disabled = false
      }
    })
  })
</script>
