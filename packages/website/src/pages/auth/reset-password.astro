---
/**
 * Reset Password Page
 *
 * SMI-1168: User registration and login
 *
 * Allows users to set a new password after receiving a reset email.
 */

import { ViewTransitions } from 'astro:transitions';
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/logo-icon.svg" />

    <meta name="description" content="Set your new Skillsmith password" />
    <title>Reset Password | Skillsmith</title>
    <link rel="preconnect" href="https://api.fontshare.com" crossorigin />
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@300,400,500,700,900&display=swap" rel="stylesheet" />
    <ViewTransitions />
  </head>
  <body>
    <header class="header">
      <nav class="nav">
        <a href="/" class="logo">
          <svg width="32" height="32" viewBox="0 0 64 64" class="logo-icon-svg">
            <rect width="64" height="64" fill="transparent" rx="8"/>
            <g transform="translate(32, 32)">
              <path d="M 10 -18 Q -10 -14, -10 -4 Q -10 4, 10 8 Q 10 16, -10 20"
                    stroke="currentColor" stroke-width="1.5" stroke-opacity="0.3" fill="none"/>
              <circle cx="10" cy="-18" r="5" fill="#E07A5F"/>
              <circle cx="-10" cy="-4" r="5" fill="#E07A5F"/>
              <circle cx="10" cy="8" r="5" fill="#E07A5F"/>
              <circle cx="-10" cy="20" r="5" fill="#E07A5F"/>
            </g>
          </svg>
          <span class="logo-text">Skillsmith</span>
        </a>
      </nav>
    </header>

    <main class="auth-container">
      <div class="auth-card">
        <div id="form-container">
          <div class="auth-header">
            <h1>Set new password</h1>
            <p>Choose a strong password for your account</p>
          </div>

          <form id="reset-form" class="auth-form">
            <div class="form-group">
              <label for="password">New Password</label>
              <input
                type="password"
                id="password"
                name="password"
                placeholder="Min. 8 characters"
                required
                autocomplete="new-password"
                minlength="8"
              />
              <p class="input-hint">At least 8 characters</p>
            </div>

            <div class="form-group">
              <label for="confirm-password">Confirm Password</label>
              <input
                type="password"
                id="confirm-password"
                name="confirmPassword"
                placeholder="Confirm your password"
                required
                autocomplete="new-password"
                minlength="8"
              />
            </div>

            <div id="error-message" class="error-message" style="display: none;"></div>

            <button type="submit" class="btn btn-primary btn-full" id="submit-btn">
              <span class="btn-text">Update Password</span>
              <span class="btn-loading" style="display: none;">
                <svg class="spinner" viewBox="0 0 24 24">
                  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" opacity="0.25"/>
                  <path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="4" fill="none"/>
                </svg>
                Updating...
              </span>
            </button>
          </form>
        </div>

        <div id="success-container" style="display: none;">
          <div class="success-content">
            <div class="icon-container">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12" />
              </svg>
            </div>
            <h1>Password Updated!</h1>
            <p>Your password has been successfully changed. You can now sign in with your new password.</p>
            <a href="/login" class="btn btn-primary btn-full">Sign In</a>
          </div>
        </div>

        <div id="invalid-link" style="display: none;">
          <div class="error-content">
            <div class="icon-container error">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <line x1="15" y1="9" x2="9" y2="15" />
                <line x1="9" y1="9" x2="15" y2="15" />
              </svg>
            </div>
            <h1>Invalid Reset Link</h1>
            <p>This password reset link is invalid or has expired. Please request a new one.</p>
            <a href="/auth/forgot-password" class="btn btn-primary btn-full">Request New Link</a>
          </div>
        </div>
      </div>
    </main>
  </body>
</html>

<style>
  *,
  *::before,
  *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Satoshi', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    line-height: 1.6;
    color: #FAFAFA;
    background: #0D0D0F;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  .header {
    background: rgba(13, 13, 15, 0.95);
    backdrop-filter: blur(8px);
    border-bottom: 1px solid #1f1f23;
  }

  .nav {
    max-width: 1280px;
    margin: 0 auto;
    padding: 1rem 2rem;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    font-weight: 700;
    font-size: 1.25rem;
    color: #FAFAFA;
  }

  .auth-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }

  .auth-card {
    width: 100%;
    max-width: 400px;
    background: #121214;
    border-radius: 1rem;
    padding: 2rem;
    border: 1px solid #2a2a2f;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
  }

  .auth-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .auth-header h1 {
    font-size: 1.75rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }

  .auth-header p {
    color: #9ca3af;
  }

  .auth-form {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-group label {
    font-size: 0.875rem;
    font-weight: 500;
  }

  .form-group input {
    padding: 0.75rem 1rem;
    font-size: 1rem;
    border: 1px solid #2a2a2f;
    border-radius: 0.5rem;
    background: #1a1a1f;
    color: #FAFAFA;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .form-group input::placeholder {
    color: #6b7280;
  }

  .form-group input:focus {
    outline: none;
    border-color: #E07A5F;
    box-shadow: 0 0 0 3px rgba(224, 122, 95, 0.1);
  }

  .input-hint {
    font-size: 0.75rem;
    color: #6b7280;
  }

  .error-message {
    background: rgba(220, 38, 38, 0.1);
    border: 1px solid rgba(220, 38, 38, 0.3);
    color: #f87171;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
    font-weight: 600;
    text-decoration: none;
    border-radius: 0.5rem;
    transition: all 0.2s;
    cursor: pointer;
    border: none;
  }

  .btn-primary {
    background: linear-gradient(135deg, #E07A5F 0%, #D4694E 100%);
    color: white;
  }

  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(224, 122, 95, 0.4);
  }

  .btn-primary:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
  }

  .btn-full {
    width: 100%;
  }

  .spinner {
    width: 1.25rem;
    height: 1.25rem;
    margin-right: 0.5rem;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .success-content,
  .error-content {
    text-align: center;
  }

  .success-content h1,
  .error-content h1 {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }

  .success-content p,
  .error-content p {
    color: #9ca3af;
    margin-bottom: 1.5rem;
  }

  .icon-container {
    width: 4rem;
    height: 4rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1.5rem;
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
  }

  .icon-container.error {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
  }

  .icon-container svg {
    width: 2rem;
    height: 2rem;
  }
</style>

<script>
  import { createClient } from '@supabase/supabase-js'

  const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL
  const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY

  document.addEventListener('DOMContentLoaded', async () => {
    const formContainer = document.getElementById('form-container')!
    const successContainer = document.getElementById('success-container')!
    const invalidLink = document.getElementById('invalid-link')!
    const form = document.getElementById('reset-form') as HTMLFormElement
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement
    const errorMessage = document.getElementById('error-message') as HTMLDivElement

    if (!supabaseUrl || !supabaseAnonKey) {
      formContainer.style.display = 'none'
      invalidLink.style.display = 'block'
      return
    }

    const supabase = createClient(supabaseUrl, supabaseAnonKey)

    // Check for recovery token in URL hash
    const hashParams = new URLSearchParams(window.location.hash.substring(1))
    const accessToken = hashParams.get('access_token')
    const refreshToken = hashParams.get('refresh_token')
    const type = hashParams.get('type')

    if (type === 'recovery' && accessToken && refreshToken) {
      // Set session with recovery tokens
      const { error } = await supabase.auth.setSession({
        access_token: accessToken,
        refresh_token: refreshToken,
      })

      if (error) {
        formContainer.style.display = 'none'
        invalidLink.style.display = 'block'
        return
      }
    } else {
      // Check if user has an active session (recovery flow)
      const { data: { session } } = await supabase.auth.getSession()
      if (!session) {
        formContainer.style.display = 'none'
        invalidLink.style.display = 'block'
        return
      }
    }

    // Handle form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault()

      errorMessage.style.display = 'none'

      const formData = new FormData(form)
      const password = formData.get('password') as string
      const confirmPassword = formData.get('confirmPassword') as string

      // Validate passwords match
      if (password !== confirmPassword) {
        errorMessage.textContent = 'Passwords do not match.'
        errorMessage.style.display = 'block'
        return
      }

      // Show loading state
      const btnText = submitBtn.querySelector('.btn-text') as HTMLSpanElement
      const btnLoading = submitBtn.querySelector('.btn-loading') as HTMLSpanElement
      btnText.style.display = 'none'
      btnLoading.style.display = 'inline-flex'
      submitBtn.disabled = true

      try {
        const { error } = await supabase.auth.updateUser({
          password,
        })

        if (error) {
          throw new Error(error.message)
        }

        // Sign out after password change for security
        await supabase.auth.signOut()

        // Show success
        formContainer.style.display = 'none'
        successContainer.style.display = 'block'
      } catch (error) {
        console.error('Password update error:', error)
        errorMessage.textContent = error instanceof Error ? error.message : 'An error occurred. Please try again.'
        errorMessage.style.display = 'block'
      } finally {
        btnText.style.display = 'inline'
        btnLoading.style.display = 'none'
        submitBtn.disabled = false
      }
    })
  })
</script>
