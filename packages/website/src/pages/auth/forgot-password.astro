---
/**
 * Forgot Password Page
 *
 * SMI-1168: User registration and login
 *
 * Allows users to request a password reset email.
 */

import { ViewTransitions } from 'astro:transitions';
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/logo-icon.svg" />

    <meta name="description" content="Reset your Skillsmith password" />
    <title>Forgot Password | Skillsmith</title>
    <link rel="preconnect" href="https://api.fontshare.com" crossorigin />
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@300,400,500,700,900&display=swap" rel="stylesheet" />
    <ViewTransitions />
  </head>
  <body>
    <header class="header">
      <nav class="nav">
        <a href="/" class="logo">
          <svg width="32" height="32" viewBox="0 0 64 64" class="logo-icon-svg">
            <rect width="64" height="64" fill="transparent" rx="8"/>
            <g transform="translate(32, 32)">
              <path d="M 10 -18 Q -10 -14, -10 -4 Q -10 4, 10 8 Q 10 16, -10 20"
                    stroke="currentColor" stroke-width="1.5" stroke-opacity="0.3" fill="none"/>
              <circle cx="10" cy="-18" r="5" fill="#E07A5F"/>
              <circle cx="-10" cy="-4" r="5" fill="#E07A5F"/>
              <circle cx="10" cy="8" r="5" fill="#E07A5F"/>
              <circle cx="-10" cy="20" r="5" fill="#E07A5F"/>
            </g>
          </svg>
          <span class="logo-text">Skillsmith</span>
        </a>
      </nav>
    </header>

    <main class="auth-container">
      <div class="auth-card">
        <div class="auth-header">
          <h1>Reset your password</h1>
          <p>Enter your email and we'll send you a reset link</p>
        </div>

        <form id="forgot-form" class="auth-form">
          <div class="form-group">
            <label for="email">Email</label>
            <input
              type="email"
              id="email"
              name="email"
              placeholder="you@example.com"
              required
              autocomplete="email"
            />
          </div>

          <div id="error-message" class="error-message" style="display: none;"></div>
          <div id="success-message" class="success-message" style="display: none;"></div>

          <button type="submit" class="btn btn-primary btn-full" id="submit-btn">
            <span class="btn-text">Send Reset Link</span>
            <span class="btn-loading" style="display: none;">
              <svg class="spinner" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" opacity="0.25"/>
                <path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="4" fill="none"/>
              </svg>
              Sending...
            </span>
          </button>
        </form>

        <div class="auth-alternate">
          <p>Remember your password? <a href="/login">Sign in</a></p>
        </div>
      </div>
    </main>
  </body>
</html>

<style>
  *,
  *::before,
  *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Satoshi', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    line-height: 1.6;
    color: #FAFAFA;
    background: #0D0D0F;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  .header {
    background: rgba(13, 13, 15, 0.95);
    backdrop-filter: blur(8px);
    border-bottom: 1px solid #1f1f23;
  }

  .nav {
    max-width: 1280px;
    margin: 0 auto;
    padding: 1rem 2rem;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    font-weight: 700;
    font-size: 1.25rem;
    color: #FAFAFA;
  }

  .auth-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }

  .auth-card {
    width: 100%;
    max-width: 400px;
    background: #121214;
    border-radius: 1rem;
    padding: 2rem;
    border: 1px solid #2a2a2f;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
  }

  .auth-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .auth-header h1 {
    font-size: 1.75rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }

  .auth-header p {
    color: #9ca3af;
  }

  .auth-form {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-group label {
    font-size: 0.875rem;
    font-weight: 500;
  }

  .form-group input {
    padding: 0.75rem 1rem;
    font-size: 1rem;
    border: 1px solid #2a2a2f;
    border-radius: 0.5rem;
    background: #1a1a1f;
    color: #FAFAFA;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .form-group input::placeholder {
    color: #6b7280;
  }

  .form-group input:focus {
    outline: none;
    border-color: #E07A5F;
    box-shadow: 0 0 0 3px rgba(224, 122, 95, 0.1);
  }

  .error-message {
    background: rgba(220, 38, 38, 0.1);
    border: 1px solid rgba(220, 38, 38, 0.3);
    color: #f87171;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
  }

  .success-message {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.3);
    color: #34d399;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
    font-weight: 600;
    text-decoration: none;
    border-radius: 0.5rem;
    transition: all 0.2s;
    cursor: pointer;
    border: none;
  }

  .btn-primary {
    background: linear-gradient(135deg, #E07A5F 0%, #D4694E 100%);
    color: white;
  }

  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(224, 122, 95, 0.4);
  }

  .btn-primary:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
  }

  .btn-full {
    width: 100%;
  }

  .spinner {
    width: 1.25rem;
    height: 1.25rem;
    margin-right: 0.5rem;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .auth-alternate {
    text-align: center;
    margin-top: 1.5rem;
  }

  .auth-alternate p {
    color: #9ca3af;
    font-size: 0.875rem;
  }

  .auth-alternate a {
    color: #E07A5F;
    text-decoration: none;
    font-weight: 500;
  }

  .auth-alternate a:hover {
    text-decoration: underline;
  }
</style>

<script>
  import { createClient } from '@supabase/supabase-js'

  const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL
  const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY

  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('forgot-form') as HTMLFormElement
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement
    const errorMessage = document.getElementById('error-message') as HTMLDivElement
    const successMessage = document.getElementById('success-message') as HTMLDivElement

    form.addEventListener('submit', async (e) => {
      e.preventDefault()

      // Reset messages
      errorMessage.style.display = 'none'
      successMessage.style.display = 'none'

      // Show loading state
      const btnText = submitBtn.querySelector('.btn-text') as HTMLSpanElement
      const btnLoading = submitBtn.querySelector('.btn-loading') as HTMLSpanElement
      btnText.style.display = 'none'
      btnLoading.style.display = 'inline-flex'
      submitBtn.disabled = true

      try {
        if (!supabaseUrl || !supabaseAnonKey) {
          throw new Error('Authentication service not configured')
        }

        const supabase = createClient(supabaseUrl, supabaseAnonKey)
        const formData = new FormData(form)
        const email = formData.get('email') as string

        const { error } = await supabase.auth.resetPasswordForEmail(email, {
          redirectTo: `${window.location.origin}/auth/reset-password`,
        })

        if (error) {
          throw new Error(error.message)
        }

        successMessage.innerHTML = `
          <strong>Check your email!</strong><br>
          We've sent a password reset link to <strong>${email}</strong>.
        `
        successMessage.style.display = 'block'
        form.reset()
      } catch (error) {
        console.error('Password reset error:', error)
        errorMessage.textContent = error instanceof Error ? error.message : 'An error occurred. Please try again.'
        errorMessage.style.display = 'block'
      } finally {
        // Reset button state
        btnText.style.display = 'inline'
        btnLoading.style.display = 'none'
        submitBtn.disabled = false
      }
    })
  })
</script>
