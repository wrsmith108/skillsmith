# Pre-push hook: Uncommitted changes warning + Security checks
# Issues: SMI-727, SMI-1342
#
# This hook runs two sets of checks before allowing a push to remote:
#   1. Warns about uncommitted changes (SMI-1342) - prevents accidental loss
#   2. Security checks (SMI-727) - prevents vulnerabilities in production
#
# Configuration:
#   --no-verify  - Skip all hooks (use with caution): git push --no-verify
#
# Checks performed:
#   Phase 1 (SMI-1342): Uncommitted changes detection
#     - Staged changes (added but not committed)
#     - Unstaged changes (modified but not added)
#     - Untracked files (new files not in git)
#   Phase 2 (SMI-727): Security checks
#     - Security test suite (packages/core/tests/security/)
#     - npm audit (high severity or above)
#     - Hardcoded secrets pattern detection
#
# Exit codes:
#   0 - All checks passed (or user confirmed)
#   1 - Check failed or user aborted

# Phase 1: Check for uncommitted changes (SMI-1342)
# This runs first to warn developers before they push
bash "$(dirname "$0")/../scripts/pre-push-uncommitted-check.sh"
UNCOMMITTED_STATUS=$?

# If user chose to abort, stop here
if [ $UNCOMMITTED_STATUS -ne 0 ]; then
  exit 1
fi

# Phase 2: Run security checks (SMI-727)
bash "$(dirname "$0")/../scripts/pre-push-check.sh"
SECURITY_STATUS=$?

if [ $SECURITY_STATUS -ne 0 ]; then
  exit 1
fi

# Phase 3: Coverage validation (SMI-1602 follow-up)
# Catches coverage issues before code leaves local machine
echo "üîç Running pre-push coverage check..."

# Check if Docker is available
if ! docker exec skillsmith-dev-1 echo "ok" > /dev/null 2>&1; then
  echo "‚ö†Ô∏è  Docker not running - skipping coverage check"
  echo "   Run: docker compose --profile dev up -d"
  exit 0  # Don't block push, just warn
fi

# Run coverage check (uses existing test:coverage script)
if docker exec skillsmith-dev-1 npm run test:coverage > /dev/null 2>&1; then
  echo "‚úÖ Coverage check passed"
else
  echo ""
  echo "‚ùå Coverage threshold not met!"
  echo "   Run: docker exec skillsmith-dev-1 npm run test:coverage"
  echo "   to see detailed report"
  echo ""
  echo "   Bypass: git push --no-verify"
  exit 1
fi
