#!/bin/sh
# SMI-1346: Enhanced pre-commit hook with early lint error detection
# SMI-1774: Use Docker for typecheck to ensure consistent environment

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo ""
echo "${BLUE}=== Pre-Commit Checks ===${NC}"
echo ""

# =============================================================================
# Detect execution environment (Docker vs Local)
# =============================================================================
USE_DOCKER=0
DOCKER_CONTAINER="skillsmith-dev-1"

# Check if Docker is available and container is running
if command -v docker > /dev/null 2>&1; then
  if docker ps --format '{{.Names}}' 2>/dev/null | grep -q "^${DOCKER_CONTAINER}$"; then
    USE_DOCKER=1
    echo "${BLUE}ğŸ³ Using Docker container: ${DOCKER_CONTAINER}${NC}"
  else
    echo "${YELLOW}âš ï¸  Docker container '${DOCKER_CONTAINER}' not running - using local environment${NC}"
    echo "${YELLOW}   Start with: docker compose --profile dev up -d${NC}"
  fi
else
  echo "${YELLOW}â„¹ï¸  Docker not available - using local environment${NC}"
fi
echo ""

# Helper function to run commands in Docker or locally
# SMI-1774: Use -w /app to support running from worktree directories
run_cmd() {
  if [ $USE_DOCKER -eq 1 ]; then
    docker exec -w /app $DOCKER_CONTAINER "$@"
  else
    "$@"
  fi
}

# Phase 0: Secret Detection with Gitleaks
echo "${YELLOW}[0/3] Scanning for secrets...${NC}"
if gitleaks protect --staged --no-banner 2>/dev/null; then
    echo "${GREEN}  âœ“ No secrets detected${NC}"
else
    echo ""
    echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo "${RED}  âœ— Potential Secrets Detected!${NC}"
    echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "  ${YELLOW}Details:${NC}"
    gitleaks protect --staged --no-banner -v 2>/dev/null || true
    echo ""
    echo "  ${YELLOW}How to fix:${NC}"
    echo "    1. Remove the secret from your staged files"
    echo "    2. Use environment variables instead"
    echo "    3. Add to .env (which is gitignored)"
    echo ""
    echo "  ${YELLOW}False positive?${NC} Add to .gitleaks.toml allowlist"
    echo ""
    exit 1
fi

# Phase 1: Clear TypeScript build cache (SMI-1348)
# Prevents stale .tsbuildinfo from causing false positive type errors
echo "${YELLOW}[1/3] Clearing TypeScript build cache...${NC}"
run_cmd npx tsc --build --clean > /dev/null 2>&1 || true
echo "${GREEN}  âœ“ Build cache cleared${NC}"

# Phase 2: TypeScript Type Checking (SMI-1886: Optimized to check only changed packages)
echo "${YELLOW}[2/3] Running TypeScript type check...${NC}"

# Detect which packages have staged changes
CHANGED_PACKAGES=$(git diff --cached --name-only | grep '^packages/' | cut -d'/' -f2 | sort -u)
NON_PACKAGE_CHANGES=$(git diff --cached --name-only | grep -v '^packages/' | grep -E '\.(ts|tsx)$' | head -1)

TYPECHECK_FAILED=0
PACKAGES_CHECKED=""

# If we have non-package TypeScript changes OR no package-specific changes, run full typecheck
if [ -n "$NON_PACKAGE_CHANGES" ] || [ -z "$CHANGED_PACKAGES" ]; then
    echo "  Running full typecheck (non-package changes detected)..."
    if ! run_cmd npm run typecheck; then
        TYPECHECK_FAILED=1
    fi
    PACKAGES_CHECKED="all"
else
    # Only typecheck packages with staged changes
    for pkg in $CHANGED_PACKAGES; do
        PKG_TSCONFIG="packages/$pkg/tsconfig.json"
        if [ -f "$PKG_TSCONFIG" ]; then
            echo "  Checking packages/$pkg..."
            if ! run_cmd npx tsc --noEmit --project "$PKG_TSCONFIG"; then
                TYPECHECK_FAILED=1
            fi
            PACKAGES_CHECKED="$PACKAGES_CHECKED $pkg"
        fi
    done
fi

if [ $TYPECHECK_FAILED -eq 0 ]; then
    if [ "$PACKAGES_CHECKED" = "all" ]; then
        echo "${GREEN}  âœ“ TypeScript check passed (full)${NC}"
    else
        echo "${GREEN}  âœ“ TypeScript check passed (packages:$PACKAGES_CHECKED)${NC}"
    fi
else
    echo ""
    echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo "${RED}  âœ— TypeScript Errors Found${NC}"
    echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "  ${YELLOW}How to fix:${NC}"
    echo "    1. Review the errors above"
    echo "    2. Fix type errors in the listed files"
    if [ $USE_DOCKER -eq 1 ]; then
      echo "    3. Run 'docker exec -w /app $DOCKER_CONTAINER npm run typecheck' to verify"
    else
      echo "    3. Run 'npm run typecheck' to verify fixes"
    fi
    echo ""
    echo "  ${YELLOW}Emergency bypass:${NC} git commit --no-verify"
    echo ""
    exit 1
fi

# Phase 3: Lint and Format (staged files only)
echo "${YELLOW}[3/3] Running lint and format on staged files...${NC}"
if npx lint-staged; then
    echo "${GREEN}  âœ“ Lint and format passed${NC}"
else
    echo ""
    echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo "${RED}  âœ— Lint Errors Found${NC}"
    echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "  ${YELLOW}Common issues and fixes:${NC}"
    echo ""
    echo "  ${BLUE}Unused imports:${NC}"
    echo "    - Remove: import { UnusedType } from './module'"
    echo "    - Or prefix with underscore: import { _UnusedType } from './module'"
    echo ""
    echo "  ${BLUE}Unused variables:${NC}"
    echo "    - Remove the variable declaration"
    echo "    - Or prefix with underscore: const _unused = value"
    echo ""
    echo "  ${BLUE}Unnecessary escapes in regex:${NC}"
    echo "    - Remove backslash: /\\)/ â†’ /\\)/ (if needed) or /\)/ â†’ /)/"
    echo ""
    echo "  ${YELLOW}Quick fix:${NC}"
    echo "    npm run lint:fix    # Auto-fix what can be fixed"
    echo "    npm run lint        # See remaining errors"
    echo ""
    echo "  ${YELLOW}Emergency bypass:${NC} git commit --no-verify"
    echo ""
    exit 1
fi

echo ""
echo "${GREEN}=== All Pre-Commit Checks Passed ===${NC}"
echo ""
